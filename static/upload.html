<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Upload & Ingest Files</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#0f172a; --panel:#111827; --text:#e5e7eb; --muted:#9ca3af; --accent:#3b82f6; --ok:#10b981; --err:#ef4444; }
    body { margin:0; font-family:system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; background:var(--bg); color:var(--text); }
    .wrap { max-width: 820px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 20px; font-weight: 700; margin: 0 0 12px; }
    p { color: var(--muted); margin: 0 0 18px; }
    .card { background: var(--panel); border: 1px solid #1f2937; border-radius: 10px; padding: 18px; }
    .row { display:flex; gap: 12px; align-items:center; flex-wrap:wrap; margin-bottom: 12px; }
    .file-input { display:none; }
    .btn { background: var(--accent); color:white; border:0; padding: 10px 14px; border-radius:8px; cursor:pointer; font-weight:600; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .drop { border:2px dashed #334155; border-radius:10px; padding: 24px; text-align:center; color:var(--muted); transition: .15s border-color; }
    .drop.dragover { border-color: var(--accent); color: var(--text); }
    .list { margin-top: 14px; display:grid; gap:10px; }
    .item { background:#0b1220; border:1px solid #1f2937; border-radius:10px; padding:12px; }
    .item-head { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    .name { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .badge { font-size:12px; color:#d1d5db; }
    .bar { height:8px; border-radius:999px; background:#0f172a; border:1px solid #1f2937; margin-top:8px; overflow:hidden; }
    .fill { height:100%; width:0%; background:var(--accent); transition: width .15s linear; }
    .status { margin-top:6px; font-size:12px; color:var(--muted); }
    .status.ok { color: var(--ok); }
    .status.err { color: var(--err); }
    .footer { margin-top: 14px; display:flex; gap:10px; align-items:center; }
    .small { font-size:12px; color:var(--muted); }
    .resp { margin-top:16px; background:#0b1220; border:1px solid #1f2937; border-radius:10px; padding:12px; max-height:260px; overflow:auto; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:12px; color:#d1d5db;}
    a { color:#93c5fd; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Upload & Ingest Files</h1>
    <p>Upload PDFs, DOCX, XLSX (legacy DOC will be auto-converted if LibreOffice is available). Files will be parsed and indexed for the chatbot.</p>

    <div class="card">
      <div class="row">
        <button id="pickBtn" class="btn">Choose files</button>
        <button id="uploadBtn" class="btn" disabled>Upload & Ingest</button>
        <span class="small">You can also drag &amp; drop files below.</span>
      </div>

      <input id="fileInput" class="file-input" type="file" multiple />
      <div id="drop" class="drop">Drag &amp; drop files here…</div>
      <div id="list" class="list"></div>

      <div class="footer">
        <span class="small">Endpoint: <code id="ep">/ingest/upload</code></span>
        <span class="small">After upload, ask questions on <a href="/">the chat page</a>.</span>
      </div>

      <pre id="resp" class="resp" hidden></pre>
    </div>
  </div>

  <script>
const ENDPOINT = "/ingest/upload";
document.getElementById('ep').textContent = ENDPOINT;

const fileInput = document.getElementById('fileInput');
const pickBtn   = document.getElementById('pickBtn');
const uploadBtn = document.getElementById('uploadBtn');
const dropZone  = document.getElementById('drop');
const listEl    = document.getElementById('list');
const respEl    = document.getElementById('resp');

let queue = []; // { file, el, bar, statusEl }

function bytes(n){ return n < 1024 ? n+' B' : n<1048576 ? (n/1024).toFixed(1)+' KB' : (n/1048576).toFixed(1)+' MB'; }

function addFiles(files) {
  for (const file of files) {
    const el = document.createElement('div');
    el.className = 'item';
    el.innerHTML = `
      <div class="item-head">
        <div class="name" title="${file.name}">${file.name}</div>
        <div class="badge">${bytes(file.size)}</div>
      </div>
      <div class="bar"><div class="fill"></div></div>
      <div class="status">Queued</div>
    `;
    listEl.appendChild(el);
    queue.push({ file, el, bar: el.querySelector('.fill'), statusEl: el.querySelector('.status') });
  }
  uploadBtn.disabled = queue.length === 0;
}

pickBtn.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => addFiles(e.target.files));

['dragenter','dragover'].forEach(ev => dropZone.addEventListener(ev, e => {
  e.preventDefault(); e.stopPropagation(); dropZone.classList.add('dragover');
}));
['dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, e => {
  e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('dragover');
}));
dropZone.addEventListener('drop', e => addFiles(e.dataTransfer.files));

async function uploadAll() {
  respEl.hidden = true;
  uploadBtn.disabled = true;
  pickBtn.disabled = true;

  try {
    const form = new FormData();
    if (queue.length === 0) throw new Error("No files queued");
    queue.forEach(({file}) => form.append('files', file, file.name));

    // 1) Kick off the job (returns 202 + job_id)
    const startRes = await fetch(ENDPOINT, { method: 'POST', body: form });
    const startJson = await startRes.json();
    if (startRes.status !== 202) throw new Error(startJson.error || `Upload failed (HTTP ${startRes.status})`);
    const jobId = startJson.job_id;

    // Mark client upload as done (blue bar full)
    queue.forEach(it => { it.bar.style.width = '100%'; it.statusEl.textContent = 'Processing…'; });

    // 2) Poll status until done/error
    let done = false;
    while (!done) {
      const r = await fetch(`/ingest/status/${jobId}`);
      const s = await r.json();

      let label = s.status;
      if (s.status === 'processing') label = s.note || 'Processing…';
      if (s.status === 'done')       label = `Ingested (chunks_added: ${s?.result?.chunks_added ?? "?"})`;
      if (s.status === 'error')      label = `Error: ${s.error}`;

      (s.uploaded || queue.map(q => q.file.name)).forEach(name => {
        // update every file row
        // (we don't need a precise match per-file since ingestion is batched)
        queue.forEach(it => it.statusEl.textContent = label);
        if (s.status === 'done') queue.forEach(it => it.statusEl.classList.add('ok'));
        if (s.status === 'error') queue.forEach(it => it.statusEl.classList.add('err'));
      });

      respEl.hidden = false;
      respEl.textContent = `Status: ${s.status}\n\n` + JSON.stringify(s, null, 2);

      if (s.status === 'done' || s.status === 'error') done = true;
      else await new Promise(t => setTimeout(t, 2000));
    }

    // Reset
    queue = [];
    pickBtn.disabled = false;

  } catch (err) {
    queue.forEach(it => { it.statusEl.textContent = 'Error'; it.statusEl.classList.add('err'); });
    respEl.hidden = false;
    respEl.textContent = 'Client error: ' + (err?.message || err);
    pickBtn.disabled = false;
  }
}

uploadBtn.addEventListener('click', uploadAll);
</script>

</body>
</html>
